<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È∫ªÂ∞ÜÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-setup {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .setup-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .setup-row label {
            font-size: 1.1em;
            min-width: 80px;
        }

        .setup-row input,
        .setup-row select {
            padding: 8px 12px;
            border-radius: 5px;
            border: none;
            font-size: 1em;
        }

        button {
            padding: 10px 25px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .game-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .info-item {
            text-align: center;
        }

        .info-item label {
            display: block;
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .players-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-card {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .player-card.current {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .player-card.dealer {
            background: rgba(255,215,0,0.2);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .player-name {
            font-size: 1.2em;
            font-weight: bold;
        }

        .player-score {
            font-size: 1.1em;
            color: #FFD700;
        }

        .player-status {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .discarded-tiles {
            margin-top: 10px;
            min-height: 40px;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .my-hand {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .my-hand h3 {
            margin-bottom: 15px;
        }

        .hand-tiles {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }

        .tile {
            width: 50px;
            height: 70px;
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            border: 2px solid #333;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        .tile:hover:not(.disabled) {
            transform: translateY(-5px);
            box-shadow: 2px 7px 10px rgba(0,0,0,0.4);
        }

        .tile.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .tile.small {
            width: 30px;
            height: 40px;
            font-size: 0.8em;
        }

        .tile.wan { color: #e74c3c; }
        .tile.tiao { color: #27ae60; }
        .tile.tong { color: #3498db; }
        .tile.feng { color: #9b59b6; }
        .tile.jian { color: #e67e22; }

        .actions {
            text-align: center;
            margin-top: 20px;
        }

        .actions button {
            margin: 0 10px;
            font-size: 1.1em;
            padding: 12px 30px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .modal-content p {
            font-size: 1.2em;
            margin-bottom: 25px;
        }

        .scores-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }

        .scores-table th,
        .scores-table td {
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .scores-table th {
            background: rgba(0,0,0,0.3);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            text-align: center;
        }

        .message.error {
            background: rgba(231,76,60,0.3);
        }

        .message.success {
            background: rgba(46,204,113,0.3);
        }
    </style>
</head>
<body>
    <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="connectionText">ËøûÊé•‰∏≠...</span>
    </div>

    <div class="container">
        <h1>üÄÑ È∫ªÂ∞ÜÊ∏∏Êàè</h1>

        <div class="game-setup" id="setupPanel">
            <div class="setup-row">
                <label>Ê∑ªÂä†Êú∫Âô®‰∫∫:</label>
                <button onclick="addBot()" id="addBotBtn">Ê∑ªÂä†Êú∫Âô®‰∫∫</button>
                <span id="playerCount">Áé©ÂÆ∂: 0/4</span>
            </div>
            <div class="setup-row">
                <label>Ê∏∏ÊàèËΩÆÊï∞:</label>
                <select id="roundsSelect" onchange="setRounds()">
                    <option value="1">1ËΩÆ</option>
                    <option value="2">2ËΩÆ</option>
                    <option value="3">3ËΩÆ</option>
                    <option value="4">4ËΩÆ</option>
                </select>
            </div>
            <div class="setup-row">
                <button onclick="startGame()" id="startBtn" disabled>ÂºÄÂßãÊ∏∏Êàè</button>
            </div>
        </div>

        <div class="game-info" id="gameInfo" style="display: none;">
            <div class="info-item">
                <label>ÂΩìÂâçËΩÆÊ¨°</label>
                <div class="value" id="currentRound">1/1</div>
            </div>
            <div class="info-item">
                <label>Ââ©‰ΩôÁâåÊï∞</label>
                <div class="value" id="remainingTiles">0</div>
            </div>
            <div class="info-item">
                <label>ÂΩìÂâçÁé©ÂÆ∂</label>
                <div class="value" id="currentPlayerName">-</div>
            </div>
        </div>

        <div class="players-area" id="playersArea"></div>

        <div class="my-hand" id="myHand" style="display: none;">
            <h3>ÊàëÁöÑÊâãÁâå</h3>
            <div class="hand-tiles" id="handTiles"></div>
        </div>

        <div class="actions" id="gameActions" style="display: none;">
            <button onclick="doPeng()" id="pengBtn" disabled>Á¢∞</button>
            <button onclick="doGang()" id="gangBtn" disabled>Êù†</button>
            <button onclick="declareWin()" id="winBtn" disabled>ËÉ°Áâå</button>
            <button onclick="skipMeld()" id="skipBtn" disabled>Ëøá</button>
        </div>

        <div id="messageArea"></div>
    </div>

    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2 id="modalTitle">Ê∏∏ÊàèÁªìÊùü</h2>
            <p id="modalMessage"></p>
            <table class="scores-table" id="scoresTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ÊéíÂêç</th>
                        <th>Áé©ÂÆ∂</th>
                        <th>ÂàÜÊï∞</th>
                    </tr>
                </thead>
                <tbody id="scoresBody"></tbody>
            </table>
            <button onclick="nextRound()" id="nextRoundBtn">‰∏ã‰∏ÄÂ±Ä</button>
            <button onclick="closeModal()">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <script>
        let ws = null;
        let myPlayerId = null;
        let gameState = {
            players: [],
            myHand: [],
            currentPlayerIndex: -1,
            dealerIndex: -1,
            gameStarted: false,
            currentRound: 1,
            totalRounds: 1,
            canWin: false,
            canPeng: false,
            canGang: false,
            meldTile: null  // ÂèØ‰ª•Á¢∞/Êù†ÁöÑÁâå
        };

        // ËøûÊé•WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/mahjong`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocketËøûÊé•ÊàêÂäü');
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('connectionText').textContent = 'Â∑≤ËøûÊé•';
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log('Êî∂Âà∞Ê∂àÊÅØ:', message);
                handleMessage(message);
            };

            ws.onclose = () => {
                console.log('WebSocketËøûÊé•ÂÖ≥Èó≠');
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('connectionText').textContent = 'Â∑≤Êñ≠ÂºÄ';
                showMessage('ËøûÊé•Â∑≤Êñ≠ÂºÄÔºåÂ∞ùËØïÈáçÊñ∞ËøûÊé•...', 'error');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocketÈîôËØØ:', error);
            };
        }

        // Â§ÑÁêÜÊúçÂä°Âô®Ê∂àÊÅØ
        function handleMessage(message) {
            switch (message.type) {
                case 'ROOM_UPDATE':
                    handleRoomUpdate(message);
                    break;
                case 'GAME_START':
                    handleGameStart(message);
                    break;
                case 'DRAW_TILE':
                    handleDrawTile(message);
                    break;
                case 'DISCARD_TILE':
                    handleDiscardTile(message);
                    break;
                case 'CAN_MELD':
                    handleCanMeld(message);
                    break;
                case 'WIN':
                    handleWin(message);
                    break;
                case 'GAME_OVER':
                    handleGameOver(message);
                    break;
                case 'ERROR':
                    showMessage(message.message, 'error');
                    break;
                case 'PLAYER_LEFT':
                    showMessage(message.message, 'error');
                    gameState.gameStarted = false;
                    document.getElementById('setupPanel').style.display = 'block';
                    document.getElementById('gameInfo').style.display = 'none';
                    document.getElementById('myHand').style.display = 'none';
                    document.getElementById('gameActions').style.display = 'none';
                    break;
            }
        }

        // Â§ÑÁêÜÊàøÈó¥Êõ¥Êñ∞
        function handleRoomUpdate(message) {
            gameState.players = message.players;

            // ÊâæÂà∞Ëá™Â∑±ÁöÑÁé©ÂÆ∂ID
            if (myPlayerId === null) {
                for (let player of gameState.players) {
                    if (!player.isBot && player.playerId) {
                        myPlayerId = player.playerId;
                        break;
                    }
                }
            }

            updatePlayersDisplay();

            const playerCount = gameState.players.length;
            document.getElementById('playerCount').textContent = `Áé©ÂÆ∂: ${playerCount}/4`;
            document.getElementById('startBtn').disabled = playerCount !== 4;
        }

        // Â§ÑÁêÜÊ∏∏ÊàèÂºÄÂßã
        function handleGameStart(message) {
            gameState.gameStarted = true;
            gameState.myHand = message.hand || [];
            gameState.players = message.players;
            gameState.dealerIndex = message.dealerIndex;
            gameState.currentRound = message.currentRound;
            gameState.totalRounds = message.totalRounds;

            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('gameInfo').style.display = 'flex';
            document.getElementById('myHand').style.display = 'block';
            document.getElementById('gameActions').style.display = 'block';

            updateGameInfo();
            updateHandDisplay();
            updatePlayersDisplay();
            showMessage('Ê∏∏ÊàèÂºÄÂßãÔºÅ', 'success');
        }

        // Â§ÑÁêÜÊë∏Áâå
        function handleDrawTile(message) {
            if (message.tile) {
                // Êñ∞Êë∏ÁöÑÁâåÁõ¥Êé•Ê∑ªÂä†Âà∞ÊúÄÂêéÔºå‰∏çÊéíÂ∫è
                gameState.myHand.push(message.tile);
                gameState.canWin = message.canWin || false;
                updateHandDisplay();
                showMessage('‰Ω†Êë∏‰∫Ü‰∏ÄÂº†Áâå', 'success');
            }
        }

        // Â§ÑÁêÜÊâìÁâå
        function handleDiscardTile(message) {
            gameState.currentPlayerIndex = message.currentPlayerIndex;

            // Êõ¥Êñ∞Áé©ÂÆ∂ÁöÑÊâìÂá∫Áâå
            for (let player of gameState.players) {
                if (player.playerId === message.playerId) {
                    if (!player.discardedTiles) {
                        player.discardedTiles = [];
                    }
                    player.discardedTiles.push(message.tile);
                    break;
                }
            }

            if (message.remainingTiles !== undefined) {
                document.getElementById('remainingTiles').textContent = message.remainingTiles;
            }

            updatePlayersDisplay();
            updateGameInfo();
        }

        // Â§ÑÁêÜÂèØ‰ª•Á¢∞/Êù†ÁöÑÊ∂àÊÅØ
        function handleCanMeld(message) {
            gameState.canPeng = message.canPeng || false;
            gameState.canGang = message.canGang || false;
            gameState.meldTile = message.tile;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            updateMeldButtons();

            // ÊòæÁ§∫ÊèêÁ§∫
            let hints = [];
            if (gameState.canPeng) hints.push('Á¢∞');
            if (gameState.canGang) hints.push('Êù†');
            if (hints.length > 0) {
                showMessage('‰Ω†ÂèØ‰ª•Ôºö' + hints.join('/'), 'success');
            }
        }

        // Êõ¥Êñ∞Á¢∞/Êù†ÊåâÈíÆÁä∂ÊÄÅ
        function updateMeldButtons() {
            const pengBtn = document.getElementById('pengBtn');
            const gangBtn = document.getElementById('gangBtn');
            const skipBtn = document.getElementById('skipBtn');

            const hasMeldOption = gameState.canPeng || gameState.canGang;

            if (pengBtn) pengBtn.disabled = !gameState.canPeng;
            if (gangBtn) gangBtn.disabled = !gameState.canGang;
            if (skipBtn) skipBtn.disabled = !hasMeldOption;
        }

        // Á¢∞Áâå
        function doPeng() {
            if (ws && ws.readyState === WebSocket.OPEN && gameState.canPeng) {
                ws.send(JSON.stringify({
                    type: 'PENG',
                    tile: gameState.meldTile
                }));
                // ÈáçÁΩÆÁä∂ÊÄÅ
                resetMeldState();
            }
        }

        // Êù†Áâå
        function doGang() {
            if (ws && ws.readyState === WebSocket.OPEN && gameState.canGang) {
                ws.send(JSON.stringify({
                    type: 'GANG',
                    tile: gameState.meldTile
                }));
                // ÈáçÁΩÆÁä∂ÊÄÅ
                resetMeldState();
            }
        }

        // Ë∑≥ËøáÁ¢∞/Êù†
        function skipMeld() {
            resetMeldState();
            showMessage('Â∑≤ÊîæÂºÉÁ¢∞/Êù†', 'success');
        }

        // ÈáçÁΩÆÁ¢∞/Êù†Áä∂ÊÄÅ
        function resetMeldState() {
            gameState.canPeng = false;
            gameState.canGang = false;
            gameState.meldTile = null;
            updateMeldButtons();
        }

        // Â§ÑÁêÜËÉ°Áâå
        function handleWin(message) {
            const winInfo = message.winInfo;
            let msg = '';

            if (winInfo.isSelfDraw) {
                msg = `${winInfo.winnerName} Ëá™Êë∏ÔºÅÂæóÂàÜ: +${winInfo.score * 3}`;
            } else {
                msg = `${winInfo.winnerName} ËÉ°ÁâåÔºÅÁÇπÁÇÆËÄÖ: ${winInfo.discardPlayerName}ÔºåÂæóÂàÜ: ${winInfo.score}`;
            }

            showModalMessage('Êú¨Â±ÄÁªìÊùü', msg);

            // Êõ¥Êñ∞Áé©ÂÆ∂ÂàÜÊï∞
            if (gameState.players) {
                for (let player of gameState.players) {
                    if (player.playerId === winInfo.winnerId) {
                        if (winInfo.isSelfDraw) {
                            player.score += winInfo.score * 3;
                        } else {
                            player.score += winInfo.score;
                        }
                    } else if (!winInfo.isSelfDraw && player.playerId === winInfo.discardPlayerId) {
                        player.score -= winInfo.score;
                    } else if (winInfo.isSelfDraw) {
                        player.score -= winInfo.score;
                    }
                }
                updatePlayersDisplay();
            }
        }

        // Â§ÑÁêÜÊ∏∏ÊàèÁªìÊùü
        function handleGameOver(message) {
            const scores = message.scores;

            let tbody = document.getElementById('scoresBody');
            tbody.innerHTML = '';

            scores.forEach((player, index) => {
                let row = tbody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = player.playerName + (player.isBot ? ' (Êú∫Âô®‰∫∫)' : '');
                row.insertCell(2).textContent = player.score;
            });

            document.getElementById('scoresTable').style.display = 'table';
            document.getElementById('modalTitle').textContent = 'Ê∏∏ÊàèÁªìÊùü';
            document.getElementById('modalMessage').textContent = 'ÊúÄÁªàÊéíÂêçÔºö';
            document.getElementById('nextRoundBtn').style.display = 'none';
            document.getElementById('gameOverModal').classList.add('show');
        }

        // Êõ¥Êñ∞Áé©ÂÆ∂ÊòæÁ§∫
        function updatePlayersDisplay() {
            const playersArea = document.getElementById('playersArea');
            playersArea.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';

                if (index === gameState.currentPlayerIndex) {
                    card.classList.add('current');
                }
                if (player.isDealer) {
                    card.classList.add('dealer');
                }

                let statusText = '';
                if (player.isDealer) statusText += 'Â∫Ñ ';
                if (player.isBot) statusText += 'ü§ñ ';
                statusText += `ÊâãÁâå: ${player.handCount || 0}Âº†`;

                const discardedHtml = (player.discardedTiles || []).map(tile =>
                    `<div class="tile small ${getTileClass(tile)}">${getTileText(tile)}</div>`
                ).join('');

                card.innerHTML = `
                    <div class="player-header">
                        <span class="player-name">${player.playerName}</span>
                        <span class="player-score">${player.score || 0}ÂàÜ</span>
                    </div>
                    <div class="player-status">${statusText}</div>
                    <div class="discarded-tiles">${discardedHtml}</div>
                `;

                playersArea.appendChild(card);
            });
        }

        // Êõ¥Êñ∞ÊâãÁâåÊòæÁ§∫
        function updateHandDisplay() {
            const handTiles = document.getElementById('handTiles');
            handTiles.innerHTML = '';

            const isMyTurn = gameState.players[gameState.currentPlayerIndex]?.playerId === myPlayerId;

            gameState.myHand.forEach((tile, index) => {
                const tileDiv = document.createElement('div');
                tileDiv.className = `tile ${getTileClass(tile)}`;
                if (!isMyTurn) {
                    tileDiv.classList.add('disabled');
                }
                tileDiv.textContent = getTileText(tile);
                tileDiv.onclick = () => isMyTurn && discardTile(tile);
                handTiles.appendChild(tileDiv);
            });

            // Ê†πÊçÆÊúçÂä°Âô®ËøîÂõûÁöÑÁªìÊûúÂÜ≥ÂÆöÊòØÂê¶ÂêØÁî®ËÉ°ÁâåÊåâÈíÆ
            document.getElementById('winBtn').disabled = !gameState.canWin;
        }

        // Êõ¥Êñ∞Ê∏∏Êàè‰ø°ÊÅØ
        function updateGameInfo() {
            document.getElementById('currentRound').textContent =
                `${gameState.currentRound}/${gameState.totalRounds}`;

            if (gameState.players && gameState.currentPlayerIndex >= 0) {
                const currentPlayer = gameState.players[gameState.currentPlayerIndex];
                document.getElementById('currentPlayerName').textContent =
                    currentPlayer ? currentPlayer.playerName : '-';
            }
        }

        // Ëé∑ÂèñÁâåÁöÑCSSÁ±ª
        function getTileClass(tile) {
            return tile.type.toLowerCase();
        }

        // Ëé∑ÂèñÁâåÁöÑÊòæÁ§∫ÊñáÊú¨
        function getTileText(tile) {
            const types = {
                'WAN': '‰∏á',
                'TIAO': 'Êù°',
                'TONG': 'Á≠í'
            };

            if (tile.type === 'FENG') {
                const feng = ['‰∏ú', 'Âçó', 'Ë•ø', 'Âåó'];
                return feng[tile.value - 1];
            } else if (tile.type === 'JIAN') {
                const jian = ['‰∏≠', 'Âèë', 'ÁôΩ'];
                return jian[tile.value - 1];
            } else {
                return tile.value + (types[tile.type] || '');
            }
        }

        // Ê∑ªÂä†Êú∫Âô®‰∫∫
        function addBot() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ADD_BOT' }));
            }
        }

        // ËÆæÁΩÆËΩÆÊï∞
        function setRounds() {
            const rounds = parseInt(document.getElementById('roundsSelect').value);
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'SET_ROUNDS', rounds: rounds }));
            }
        }

        // ÂºÄÂßãÊ∏∏Êàè
        function startGame() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'START_GAME' }));
            }
        }

        // Êï¥ÁêÜÊâãÁâåÔºàÊåâÁ±ªÂûãÂíåÂÄºÊéíÂ∫èÔºâ
        function sortHand() {
            const typeOrder = { 'WAN': 0, 'TIAO': 1, 'TONG': 2, 'FENG': 3, 'JIAN': 4 };
            gameState.myHand.sort((a, b) => {
                if (a.type !== b.type) {
                    return typeOrder[a.type] - typeOrder[b.type];
                }
                return a.value - b.value;
            });
        }

        // ÊâìÁâå
        function discardTile(tile) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                // ‰ªéÊâãÁâå‰∏≠ÁßªÈô§ËøôÂº†Áâå
                const tileIndex = gameState.myHand.findIndex(t =>
                    t.type === tile.type && t.value === tile.value
                );
                if (tileIndex !== -1) {
                    gameState.myHand.splice(tileIndex, 1);
                    sortHand(); // ÈáçÊñ∞Êï¥ÁêÜÊâãÁâå
                    gameState.canWin = false; // ÊâìÁâåÂêéÈáçÁΩÆËÉ°ÁâåÁä∂ÊÄÅ
                    updateHandDisplay();
                }

                ws.send(JSON.stringify({
                    type: 'DISCARD_TILE',
                    tile: tile
                }));
            }
        }

        // Â£∞ÊòéËÉ°Áâå
        function declareWin() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'WIN' }));
            }
        }

        // ‰∏ã‰∏ÄÂ±Ä
        function nextRound() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'NEXT_ROUND' }));
                closeModal();
            }
        }

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(text, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            messageArea.appendChild(msg);

            setTimeout(() => {
                msg.remove();
            }, 3000);
        }

        // ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÊ∂àÊÅØ
        function showModalMessage(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('scoresTable').style.display = 'none';
            document.getElementById('nextRoundBtn').style.display = 'inline-block';
            document.getElementById('gameOverModal').classList.add('show');
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            document.getElementById('gameOverModal').classList.remove('show');
        }

        // ÂàùÂßãÂåñ
        connectWebSocket();
    </script>
</body>
</html>
